<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">

<head>
    <title>Dashboard</title>
    <th:block layout:fragment="css">
        <link rel="stylesheet" th:href="@{/css/dashboard.css}">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    </th:block>
</head>

<main layout:fragment="content">

    <!-- 상단 전체: 3개 카드 -->
    <div class="top-container">

        <!-- 프로필 카드 -->
        <div class="top-card">
            <div class="profile-card-inner">
                <img class="user-photo"
                     th:src="${(user.profileImageUrl != null && user.profileImageUrl != '') ? user.profileImageUrl : '/images/user-default.png'}"
                     alt="user">

                <div>
                    <h2>환영합니다, <span th:text="${user.nickname}"></span>님!</h2>
                    <span class="goal-tag" th:text="${goalName}"></span>
                </div>
            </div>
        </div>

        <!-- 오늘의 체중 카드 -->
        <div class="top-card">
            <div class="weight-card-inner">
                <h3>오늘의 체중</h3>

                <div class="weight-input-row">
                    <input type="number" id="todayWeightInput" placeholder="현재의 체중을 입력">
                    <button id="saveWeightBtn">입력</button>
                </div>

                <div class="weight-info">
                <span>현재의 체중:
                    <strong id="currentWeightText"
                            th:data-height="${user.height}"
                            th:text="${user.currentWeight} + ' kg'"></strong>
                </span>

                    <span>BMI:
                    <strong id="bmiValue" th:text="${user.bmi}"></strong>
                </span>

                    <span>상태:
                    <strong id="bmiStatus"></strong>
                </span>
                </div>
            </div>
            <p>

            </p>
        </div>

        <!-- 비만 위험도 카드 -->
        <div class="top-card">
            <div class="obesity-card-inner">
                <h3 class="title-with-tooltip">
                    오늘의 비만 위험도
                    <span class="tooltip">?
                        <span class="tooltip-text">
                            이 점수는 비만 여부(지속적 상태)가 아니라,<br>
                            오늘 식단이 얼마나 즉각적으로 위험도를 높일 가능성이 있는가를 나타내는 지표입니다.
                        </span>
                    </span>
                </h3>
                <div class="obesity-bar-wrapper">
                    <div class="obesity-bar-fill"
                         th:style="${'width:' + obesityPercent + '%; background:' +
                     (obesityPercent >= 70 ? '#ff4d4d' :
                     (obesityPercent >= 40 ? '#ffb84d' : '#4da6ff'))}">
                    </div>
                </div>
                <p class="obesity-percent"
                   th:text="${obesityPercent} + '%'"></p>
                <span class="obesityPercentText"></span>
            </div>
        </div>

    </div>





    <!-- 오늘의 식사 기록 -->
    <section class="log-meal">
        <h3>오늘의 식사 기록하기</h3>
        <p class="sub">AI 사진 분석 또는 입력을 통해 식사를 기록할 수 있습니다.</p>

        <div class="log-actions">
            <input type="file" id="aiFileInput" style="display:none;" accept="image/*">

            <button class="photo-upload-btn">
                <span>AI 사진 업로드</span>
            </button>

            <button class="add-meal-btn" onclick="location.href='/direct-input'">
                직접 입력
            </button>

            <div class="meal-search-area">
                <div class="search-group">
                    <input type="text"
                           id="mealSearchInput"
                           placeholder="음식명 검색"
                           autocomplete="off"
                           autocorrect="off"
                           autocapitalize="off"
                           spellcheck="false">
                    <div id="autocompleteBox" class="autocomplete-box"></div>
                    <button id="mealAddBtn">추가</button>
                </div>
            </div>

        </div>
    </section>

    <!-- 오늘의 식사 + 영양 요약 -->
    <div class="stats-section">

        <!-- 오늘의 식사 -->
        <div class="meals-card">
            <h4>오늘의 식사</h4>

            <ul class="meal-list">
                <li th:each="meal : ${todayMeals}" class="meal-item">
                    <a th:href="@{/meal/edit/{id}(id=${meal.entryId})}" class="meal-link">
                        <div class="meal-left">
                            <strong th:text="${meal.mealName}"></strong>
                            <p class="time" th:text="${meal.mealTime}"></p>
                        </div>
                        <span class="kcal" th:text="${meal.calories + ' kcal'}"></span>
                    </a>
                </li>

                <li th:if="${#lists.isEmpty(todayMeals)}" class="no-data">
                    오늘은 아직 식사 기록이 없습니다.
                </li>
            </ul>
        </div>



        <!-- 영양 요약 -->
        <div class="right-summary">

            <!-- 칼로리 -->
            <div class="summary-card">
                <div class="summary-header">
                    <p class="title">칼로리</p>
                    <h3 class="value" th:classappend="${totalCalories > goalCalories} ? ' over'">
                        <span th:text="${totalCalories}"></span> /
                        <span th:text="${goalCalories}"></span> kcal
                    </h3>
                </div>

                <div class="progress-bar">
                    <div class="progress-fill calorie-bar"
                         th:style="'width:' + ( (${totalCalories} / ${goalCalories}) > 1 ? 100 : (${totalCalories} / ${goalCalories} * 100) ) + '%'">
                    </div>
                </div>

                <p class="percent-text"
                   th:text="${(totalCalories * 100 / goalCalories) > 100 ? 100
                     : T(java.lang.Math).round((totalCalories * 100.0) / goalCalories)} + '%'"></p>
            </div>



            <!-- 탄·단·지 -->
            <div class="nutrient-summary">

                <!-- 탄수화물 -->
                <div class="summary-card">
                    <div class="summary-header">
                        <p class="title">탄수화물</p>
                        <h3 class="value" th:classappend="${totalCarbs > goal.carbsG} ? ' over'">
                            <span th:text="${totalCarbs}"></span> /
                            <span th:text="${goal.carbsG}"></span> g
                        </h3>
                    </div>

                    <div class="progress-bar">
                        <div class="progress-fill carbs-bar"
                             th:style="'width:' + ( (${totalCarbs} / ${goal.carbsG}) > 1 ? 100 : (${totalCarbs} / ${goal.carbsG} * 100) ) + '%'">
                        </div>
                    </div>

                    <p class="percent-text"
                       th:text="${(totalCarbs * 100 / goal.carbsG) > 100 ? 100
                         : T(java.lang.Math).round((totalCarbs * 100.0) / goal.carbsG)} + '%'"></p>
                </div>

                <!-- 단백질 -->
                <div class="summary-card">
                    <div class="summary-header">
                        <p class="title">단백질</p>
                        <h3 class="value" th:classappend="${totalProtein > goal.proteinG} ? ' over'">
                            <span th:text="${totalProtein}"></span> /
                            <span th:text="${goal.proteinG}"></span> g
                        </h3>
                    </div>

                    <div class="progress-bar">
                        <div class="progress-fill protein-bar"
                             th:style="'width:' + ( (${totalProtein} / ${goal.proteinG}) > 1 ? 100 : (${totalProtein} / ${goal.proteinG} * 100) ) + '%'">
                        </div>
                    </div>

                    <p class="percent-text"
                       th:text="${(totalProtein * 100 / goal.proteinG) > 100 ? 100
                         : T(java.lang.Math).round((totalProtein * 100.0) / goal.proteinG)} + '%'"></p>
                </div>

                <!-- 지방 -->
                <div class="summary-card">
                    <div class="summary-header">
                        <p class="title">지방</p>
                        <h3 class="value" th:classappend="${totalFat > goal.fatsG} ? ' over'">
                            <span th:text="${totalFat}"></span> /
                            <span th:text="${goal.fatsG}"></span> g
                        </h3>
                    </div>

                    <div class="progress-bar">
                        <div class="progress-fill fat-bar"
                             th:style="'width:' + ( (${totalFat} / ${goal.fatsG}) > 1 ? 100 : (${totalFat} / ${goal.fatsG} * 100) ) + '%'">
                        </div>
                    </div>

                    <p class="percent-text"
                       th:text="${(totalFat * 100 / goal.fatsG) > 100 ? 100
                         : T(java.lang.Math).round((totalFat * 100.0) / goal.fatsG)} + '%'"></p>
                </div>

            </div>

            <!-- 기타 -->
            <div class="extra-nutrients">

                <div class="extra-card">
                    <p class="extra-title">당류</p>
                    <h3 class="extra-value" th:text="${totalSugar + ' g'}"></h3>
                </div>

                <div class="extra-card">
                    <p class="extra-title">식이섬유</p>
                    <h3 class="extra-value" th:text="${totalFiber + ' g'}"></h3>
                </div>

                <div class="extra-card">
                    <p class="extra-title">칼슘</p>
                    <h3 class="extra-value" th:text="${totalCalcium + ' mg'}"></h3>
                </div>

                <div class="extra-card">
                    <p class="extra-title">나트륨</p>
                    <h3 class="extra-value" th:text="${totalSodium + ' mg'}"></h3>
                </div>

            </div>

        </div>

    </div> <!-- stats-section 끝 -->

</main>

<th:block layout:fragment="script">
    <script src="/js/foodWeight.js"></script>
    <script src="/js/obesityDashboard.js"></script>
    <script src="/js/foodAdd.js?v=new_ai_ver1"></script>
</th:block>



</html>
