<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.Ex02.mapper.EmailVerificationTokenMapper">

    <insert id="insertToken"
            parameterType="com.example.Ex02.dto.EmailVerificationTokenDto"
            useGeneratedKeys="true"
            keyProperty="tokenId">
        INSERT INTO EMAIL_VERIFICATION_TOKEN (
        USER_ID, TOKEN, EXPIRES_AT, CREATED_AT
        ) VALUES (
        #{userId},
        #{token},
        #{expiresAt, jdbcType=TIMESTAMP},
        NOW()
        )
    </insert>

    <select id="findValidToken" resultType="com.example.Ex02.dto.EmailVerificationTokenDto">
        SELECT TOKEN_ID, USER_ID, TOKEN, EXPIRES_AT, CREATED_AT
        FROM EMAIL_VERIFICATION_TOKEN
        WHERE TOKEN = #{token}
        AND EXPIRES_AT >= NOW()
    </select>

    <select id="findLatestByUserId" resultType="com.example.Ex02.dto.EmailVerificationTokenDto">
        SELECT TOKEN_ID, USER_ID, TOKEN, EXPIRES_AT, CREATED_AT
        FROM EMAIL_VERIFICATION_TOKEN
        WHERE USER_ID = #{userId}
        ORDER BY EXPIRES_AT DESC
        LIMIT 1
    </select>

    <delete id="deleteTokensByUserId">
        DELETE FROM EMAIL_VERIFICATION_TOKEN
        WHERE USER_ID = #{userId}
    </delete>

</mapper>
