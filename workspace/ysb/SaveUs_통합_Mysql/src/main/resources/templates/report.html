<!--
<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
    <title>SaveUs - ê±´ê°• ë¦¬í¬íŠ¸</title>
    <link rel="stylesheet" th:href="@{/css/report.css}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>

<main class="page-content" layout:fragment="content">

    <div class="report-header">
        <h2>ğŸ“Š ê±´ê°• ë¦¬í¬íŠ¸</h2>
        <div class="header-controls">
            <input type="date" id="reportDate" class="date-picker">
        </div>
    </div>

    <div id="noDataBox" class="no-data-box" style="display: none; text-align:center; padding: 50px;">
        <p style="font-size: 1.2em; color: #666; margin-bottom: 20px;">
            í•´ë‹¹ ë‚ ì§œì—ëŠ” ì‹ë‹¨ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.
        </p>
        <button onclick="location.href='/dashboard'" class="btn-go-record"
                style="padding: 10px 20px; background-color: #1DAB87; color: white; border: none; border-radius: 8px; cursor: pointer;">
            ì‹ë‹¨ ê¸°ë¡í•˜ëŸ¬ ê°€ê¸°
        </button>
    </div>

    <div class="dashboard-grid" id="dailySection" style="margin-bottom: 40px;">

        <div class="card">
            <div class="card-header" style="justify-content: space-between; align-items: center;">
                <div class="card-title">ì„ íƒì¼ ì‹ë‹¨ ë¶„ì„</div>
                <input type="date" id="dietDate" class="date-picker-small">
            </div>

            <div id="dietNoData" style="display:none; text-align:center; padding:20px; color:#888;">
                ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.
            </div>

            <div id="dietChartArea" class="chart-container">
                <canvas id="diabetesRadarChart"></canvas>
            </div>
            <div class="risk-score" id="diabetesText">ë¶„ì„ ì¤‘...</div>
        </div>

        <div class="card">
            <div class="card-header" style="justify-content: space-between; align-items: center;">
                <div class="card-title">ğŸš¨ ë¹„ë§Œ ìœ„í—˜ë„ ë¶„ì„</div>
                <input type="date" id="obesityDate" class="date-picker-small">
            </div>

            <div class="doughnut-wrapper">
                <canvas id="obesityRiskChart"></canvas>
                <div class="center-text">
                    <span id="obesityPercent">0%</span>
                    <span class="label">ìœ„í—˜ë„</span>
                </div>
            </div>

            <p class="chart-caption" style="margin-top: 10px;">* ì„ íƒì¼ ì²´ì¤‘ ê¸°ë°˜ AI ë¶„ì„</p>
        </div>

        <div class="card full-width auto-height">
            <div class="card-header">
                <div class="card-title">ğŸ¤– AI ì˜ì–‘ì‚¬ ì½”ë©˜íŠ¸</div>
            </div>
            <div class="ai-comment-box" id="aiComment">
                ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...
            </div>
        </div>
    </div>

    <hr style="border: 0; border-top: 1px solid #eee; margin: 20px 0;">

    <h3 style="margin-bottom: 20px; color: #333;">ğŸ“… ìµœê·¼ ê±´ê°• íŠ¸ë Œë“œ (Last 30 Days)</h3>

    <div class="dashboard-grid" id="commonSection">

        <div class="card full-width">
            <div class="card-header">
                <div class="card-title">ìµœê·¼ ê±´ê°• ì ìˆ˜ ì¶”ì´</div>
                <span class="badge" id="avgScoreBadge">í‰ê·  -ì </span>
            </div>
            <div class="chart-container">
                <canvas id="scoreChart"></canvas>
            </div>
        </div>

        <div class="card full-width">
            <div class="card-header">
                <div class="card-title">ğŸ¥¦ 3ëŒ€ ì˜ì–‘ì†Œ ë°¸ëŸ°ìŠ¤ ë³€í™”</div>
            </div>
            <div style="display: flex; flex-direction: column; gap: 20px;">
                <div style="height: 150px; position: relative;">
                    <canvas id="carbChart"></canvas>
                </div>
                <div style="height: 150px; position: relative;">
                    <canvas id="proteinChart"></canvas>
                </div>
                <div style="height: 150px; position: relative;">
                    <canvas id="fatChart"></canvas>
                </div>
            </div>
        </div>

        <div class="card full-width auto-height">
            <div class="card-header">
                <div class="card-title">ğŸ”¥ ìì£¼ ë¨¹ëŠ” ìŒì‹ TOP 5</div>
            </div>
            <div class="top-meals-list">
                <ul id="topMealsList"></ul>
            </div>
        </div>
    </div>

</main>

<th:block layout:fragment="script">
    <script>
        const COLOR_PRIMARY = '#1DAB87';
        const COLOR_DANGER = '#FF6B6B';
        const COLOR_WARNING = '#FFC857';

        // ì°¨íŠ¸ ë³€ìˆ˜ë“¤
        let scoreChart, radarChart, obesityChart;
        let carbChart, proteinChart, fatChart;

        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date().toISOString().split('T')[0];
            const datePicker = document.getElementById('reportDate');
            datePicker.value = today;

            // ì´ˆê¸° ë¡œë”©
            loadReportData(today);

            // ë‚ ì§œ ë³€ê²½ ì‹œ ì´ë²¤íŠ¸
            datePicker.addEventListener('change', (e) => {
                loadReportData(e.target.value);
            });
        });

        function loadReportData(date) {
            fetch(`/api/report/daily?date=${date}`)
                .then(res => res.json())
                .then(data => renderView(data))
                .catch(err => console.error(err));
        }

        function renderView(data) {
            // ===========================
            // 1. ê³µí†µ ì„¹ì…˜ (ë¬´ì¡°ê±´ ë Œë”ë§)
            // ===========================
            updateCommonCharts(data); // íŠ¸ë Œë“œ ê·¸ë˜í”„ & Top5

            // ===========================
            // 2. ì¼ì¼ ìƒì„¸ ì„¹ì…˜ (ë°ì´í„° ìœ ë¬´ì— ë”°ë¼)
            // ===========================
            const dailySection = document.getElementById('dailySection');
            const noDataBox = document.getElementById('noDataBox');

            if (!data.hasData) {
                // ë°ì´í„° ì—†ìŒ -> ìƒì„¸ ì„¹ì…˜ ìˆ¨ê¸°ê³ , ë©”ì‹œì§€ í‘œì‹œ
                dailySection.style.display = 'none';
                noDataBox.style.display = 'block';
            } else {
                // ë°ì´í„° ìˆìŒ -> ìƒì„¸ ì„¹ì…˜ í‘œì‹œ, ë©”ì‹œì§€ ìˆ¨ê¹€
                dailySection.style.display = 'grid'; // ì›ë˜ grid
                noDataBox.style.display = 'none';

                // ë°ì´í„° ë°”ì¸ë”©
                renderDailyData(data);
            }
        }

        function renderDailyData(data) {
             // í…ìŠ¤íŠ¸ ë°”ì¸ë”©
            document.getElementById('obesityBadge').innerText = `ìœ„í—˜ë„ ${parseInt(data.obesityProbability)}%`;

            // ì½”ë©˜íŠ¸ & ë‹¹ë‡¨ (null check í¬í•¨)
            if(data.diabetesComment) {
                 const riskText = data.diabetesRiskLevel ? data.diabetesRiskLevel : '';
                 document.getElementById('diabetesText').innerText =
                    `ë‹¹ë‡¨ ìœ ì‚¬ë„: ${data.diabetesSimilarity}% (${riskText})`;
                 document.getElementById('aiComment').innerHTML =
                    `<strong>[ë¶„ì„ ê²°ê³¼]</strong> ${data.diabetesComment}`;
            }

            // ì°¨íŠ¸ ì—…ë°ì´íŠ¸ (ë ˆì´ë”, ë„ë„›)
            updateDailyCharts(data);
        }

        // -&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;
        // ì°¨íŠ¸ ê·¸ë¦¬ê¸° í•¨ìˆ˜ë“¤
        // -&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;

        function updateDailyCharts(data) {
            // [ë ˆì´ë” ì°¨íŠ¸]
            const ctxRadar = document.getElementById('diabetesRadarChart');
            if (radarChart) radarChart.destroy();
            radarChart = new Chart(ctxRadar, {
                type: 'radar',
                data: {
                    labels: ['íƒ„ìˆ˜í™”ë¬¼', 'ë‹¨ë°±ì§ˆ', 'ì§€ë°©', 'ë‹¹ë¥˜', 'ë‚˜íŠ¸ë¥¨'],
                    datasets: [{
                        label: 'ë‚˜ì˜ ì„­ì·¨(%)',
                        data: data.radarMyIntake || [0,0,0,0,0],
                        borderColor: COLOR_DANGER, backgroundColor: 'rgba(255, 107, 107, 0.2)'
                    }, {
                        label: 'ê¶Œì¥(%)',
                        data: data.radarGoal || [100,100,100,100,100],
                        borderColor: COLOR_PRIMARY, backgroundColor: 'transparent', borderDash: [5,5]
                    }]
                },
                options: { responsive: true, scales: { r: { suggestedMin: 0, suggestedMax: 120 } } }
            });

            // [ë¹„ë§Œ ë„ë„› ì°¨íŠ¸]
            const ctxObesity = document.getElementById('obesityRiskChart');
            if (obesityChart) obesityChart.destroy();
            const prob = data.obesityProbability;
            obesityChart = new Chart(ctxObesity, {
                type: 'doughnut',
                data: {
                    labels: ['ìœ„í—˜', 'ì •ìƒ'],
                    datasets: [{
                        data: [prob, 100 - prob],
                        backgroundColor: [COLOR_DANGER, '#EEE'], borderWidth: 0
                    }]
                },
                options: { cutout: '70%', plugins: { legend: { display: false } } }
            });
        }

        function updateCommonCharts(data) {
            // 1. ê±´ê°• ì ìˆ˜ (Line)
            document.getElementById('avgScoreBadge').innerText = `í‰ê·  ${data.averageScore}ì `;
            const ctxScore = document.getElementById('scoreChart');
            if (scoreChart) scoreChart.destroy();
            scoreChart = new Chart(ctxScore, {
                type: 'line',
                data: {
                    labels: data.scoreDates || [],
                    datasets: [{
                        label: 'ì ìˆ˜',
                        data: data.scoreValues || [],
                        borderColor: COLOR_PRIMARY,
                        backgroundColor: 'rgba(29, 171, 135, 0.1)',
                        fill: true, tension: 0.4
                    }]
                },
                options: { responsive: true, scales: { y: { min: 0, max: 100 } }, plugins: { legend: { display: false } } }
            });

            // 2. ì‹ë‹¨ ìœ í˜• (3ê°œ ë¶„ë¦¬) - ê³µí†µ ì˜µì…˜ ìƒì„± í•¨ìˆ˜
            const createStepChart = (ctxId, chartRef, label, dates, codes, color) => {
                const ctx = document.getElementById(ctxId);
                if (chartRef) chartRef.destroy();
                return new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: dates || [],
                        datasets: [{
                            label: label,
                            data: codes || [],
                            borderColor: color, stepped: true, fill: false, borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                min: 0, max: 4,
                                ticks: {
                                    stepSize: 1,
                                    callback: function(val) {
                                        if(val === 1) return 'ì €' + label;
                                        if(val === 2) return 'ê· í˜•';
                                        if(val === 3) return 'ê³ ' + label;
                                        return '';
                                    }
                                }
                            },
                            x: { display: true }
                        },
                        plugins: { legend: { display: false }, title: { display: true, text: label + ' ì¶”ì´' } }
                    }
                });
            };

            carbChart = createStepChart('carbChart', carbChart, 'íƒ„ìˆ˜í™”ë¬¼', data.dietDates, data.carbCodes, '#FFC857');
            proteinChart = createStepChart('proteinChart', proteinChart, 'ë‹¨ë°±ì§ˆ', data.dietDates, data.proteinCodes, '#1DAB87');
            fatChart = createStepChart('fatChart', fatChart, 'ì§€ë°©', data.dietDates, data.fatCodes, '#FF6B6B');

            // 3. Top 5 ë¦¬ìŠ¤íŠ¸
            const ul = document.getElementById('topMealsList');
            ul.innerHTML = '';
            if(data.topMeals && data.topMeals.length > 0) {
                data.topMeals.forEach((m, i) => {
                    const li = document.createElement('li');
                    const category = m.mealTime ? `(${m.mealTime})` : '';
                    li.innerHTML = `<strong>${i+1}. ${m.mealName}</strong> <span style="color:#888; font-size:0.9em;">${category}</span>`;
                    ul.appendChild(li);
                });
            } else {
                ul.innerHTML = '<p style="color:#999; text-align:center;">ê¸°ë¡ ì—†ìŒ</p>';
            }
        }
    </script>
</th:block>
</body>
</html>
-->

<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
    <title>SaveUs - ê±´ê°• ë¦¬í¬íŠ¸</title>
    <link rel="stylesheet" th:href="@{/css/report.css}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* [ì¶”ê°€] ì‘ì€ ë‚ ì§œ ì„ íƒê¸° ìŠ¤íƒ€ì¼ */
        .date-picker-small {
            padding: 4px 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.9em;
            color: #555;
            cursor: pointer;
        }

        /* [ì¶”ê°€] ë„ë„› ì°¨íŠ¸ ë˜í¼: ì •ì‚¬ê°í˜• ë¹„ìœ¨ ìœ ì§€ ë° ì¤‘ì•™ ì •ë ¬ */
        .doughnut-wrapper {
            position: relative;
            width: 180px;  /* ë„ˆë¹„ ê³ ì • */
            height: 180px; /* ë†’ì´ ê³ ì • */
            margin: 20px auto; /* ì¤‘ì•™ ì •ë ¬ */
        }

        /* [ì¶”ê°€] ì¤‘ì•™ í…ìŠ¤íŠ¸ ì˜¤ë²„ë ˆì´ */
        .center-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%); /* ì •ì¤‘ì•™ ë°°ì¹˜ */
            text-align: center;
            pointer-events: none;
        }

        .center-text #obesityPercent {
            display: block;
            font-size: 26px;
            font-weight: bold;
            color: #FF6B6B;
        }

        .center-text .label {
            font-size: 12px;
            color: #999;
        }

        /* ê¸°ì¡´ CSS ë³´ì™„ */
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
    </style>
</head>

<body>

<main class="page-content" layout:fragment="content">

    <div class="report-header">
        <h2>ğŸ“Š ê±´ê°• ë¦¬í¬íŠ¸</h2>
    </div>

    <div class="dashboard-grid" id="dailySection" style="margin-bottom: 40px;">

        <div class="card">
            <div class="card-header">
                <div class="card-title">ì„ íƒì¼ ì‹ë‹¨ ë¶„ì„</div>
                <input type="date" id="dietDate" class="date-picker-small">
            </div>

            <div id="dietNoData" style="display:none; text-align:center; padding:40px 0; color:#888;">
                <p>í•´ë‹¹ ë‚ ì§œ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>
            </div>

            <div id="dietChartArea" class="chart-container">
                <canvas id="diabetesRadarChart"></canvas>
            </div>

            <div class="risk-score" id="diabetesText" style="margin-top:10px; font-size:0.95em;">ë¶„ì„ ì¤‘...</div>
        </div>

        <div class="card">
            <div class="card-header">
                <div class="card-title">ğŸš¨ ë¹„ë§Œ ìœ„í—˜ë„ ë¶„ì„</div>
                <input type="date" id="obesityDate" class="date-picker-small">
            </div>

            <div class="doughnut-wrapper">
                <canvas id="obesityRiskChart"></canvas>
                <div class="center-text">
                    <span id="obesityPercent">0%</span>
                    <span class="label">ìœ„í—˜ë„</span>
                </div>
            </div>
            <p class="chart-caption" style="text-align:center; margin-top:10px;">* ì„ íƒì¼ ì²´ì¤‘ ê¸°ë°˜ AI ì˜ˆì¸¡</p>
        </div>

        <div class="card full-width auto-height">
            <div class="card-header">
                <div class="card-title">ğŸ¤– SaveUs AI ì˜ì–‘ì‚¬ ì½”ë©˜íŠ¸</div>
            </div>
            <div class="ai-comment-box" id="aiComment">
                ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...
            </div>
        </div>
    </div>

    <hr style="border: 0; border-top: 1px solid #eee; margin: 30px 0;">

    <h3 style="margin-bottom: 20px; color: #333; font-size: 1.2rem;">ğŸ“… ìµœê·¼ ê±´ê°• íŠ¸ë Œë“œ (Last 30 Days)</h3>

    <div class="dashboard-grid" id="commonSection">

        <div class="card full-width">
            <div class="card-header">
                <div class="card-title">ìµœê·¼ ê±´ê°• ì ìˆ˜ ì¶”ì´</div>
                <span class="badge" id="avgScoreBadge">í‰ê·  -ì </span>
            </div>
            <div class="chart-container">
                <canvas id="scoreChart"></canvas>
            </div>
        </div>

        <div class="card full-width">
            <div class="card-header">
                <div class="card-title">ğŸ¥¦ 3ëŒ€ ì˜ì–‘ì†Œ ë°¸ëŸ°ìŠ¤ ë³€í™”</div>
            </div>
            <div style="display: flex; flex-direction: column; gap: 30px; padding: 10px 0;">
                <div style="height: 120px; position: relative;">
                    <canvas id="carbChart"></canvas>
                </div>
                <div style="height: 120px; position: relative;">
                    <canvas id="proteinChart"></canvas>
                </div>
                <div style="height: 120px; position: relative;">
                    <canvas id="fatChart"></canvas>
                </div>
            </div>
        </div>

        <div class="card full-width auto-height">
            <div class="card-header">
                <div class="card-title">ğŸ”¥ ìì£¼ ë¨¹ëŠ” ìŒì‹ TOP 5</div>
            </div>
            <div class="top-meals-list">
                <ul id="topMealsList"></ul>
            </div>
        </div>
    </div>

</main>

<th:block layout:fragment="script">
    <script>
        const COLOR_PRIMARY = '#1DAB87';
        const COLOR_DANGER = '#FF6B6B';
        const COLOR_WARNING = '#FFC857';

        // ì°¨íŠ¸ ë³€ìˆ˜ë“¤
        let scoreChart, radarChart, obesityChart;
        let carbChart, proteinChart, fatChart;

        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date().toISOString().split('T')[0];

            // 1. ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°
            const dietInput = document.getElementById('dietDate');
            const obesityInput = document.getElementById('obesityDate');

            // 2. ì´ˆê¸°ê°’ ì„¤ì •
            dietInput.value = today;
            obesityInput.value = today;

            // 3. ë°ì´í„° ë¡œë“œ (ë¶„ë¦¬ëœ í•¨ìˆ˜ í˜¸ì¶œ)
            loadDietSection(today);
            loadObesitySection(today);
            loadCommonData(today); // íŠ¸ë Œë“œëŠ” ì˜¤ëŠ˜ ë‚ ì§œ ê¸°ì¤€ í•œ ë²ˆë§Œ ë¡œë“œ

            // 4. ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (ê°ê° ë™ì‘)
            dietInput.addEventListener('change', (e) => {
                loadDietSection(e.target.value);
            });

            obesityInput.addEventListener('change', (e) => {
                loadObesitySection(e.target.value);
            });
        });

        // ==========================================
        // A. ì‹ë‹¨ ë¶„ì„ ë¡œë“œ (ë ˆì´ë” + ì½”ë©˜íŠ¸)
        // ==========================================
        function loadDietSection(date) {
            fetch(`/api/report/daily?date=${date}`)
                .then(res => res.json())
                .then(data => {
                    const chartArea = document.getElementById('dietChartArea');
                    const noDataMsg = document.getElementById('dietNoData');
                    const commentBox = document.getElementById('aiComment');
                    const riskText = document.getElementById('diabetesText');

                    if (!data.hasData) {
                        // ë°ì´í„° ì—†ìŒ
                        chartArea.style.display = 'none';
                        noDataMsg.style.display = 'block';
                        riskText.innerText = '-';
                        commentBox.innerText = 'í•´ë‹¹ ë‚ ì§œì—ëŠ” ê¸°ë¡ëœ ì‹ë‹¨ì´ ì—†ìŠµë‹ˆë‹¤.';
                    } else {
                        // ë°ì´í„° ìˆìŒ
                        chartArea.style.display = 'block';
                        noDataMsg.style.display = 'none';

                        // í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
                        const rLevel = data.diabetesRiskLevel ? data.diabetesRiskLevel : '';
                        riskText.innerText = `ë‹¹ë‡¨ ìœ ì‚¬ë„: ${data.diabetesSimilarity}% (${rLevel})`;

                        if(data.diabetesComment) {
                            commentBox.innerHTML = `<strong>[ë¶„ì„ ê²°ê³¼]</strong> ${data.diabetesComment}`;
                        } else {
                            commentBox.innerText = "ë¶„ì„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.";
                        }

                        // ë ˆì´ë” ì°¨íŠ¸ ê·¸ë¦¬ê¸°
                        updateRadarChart(data);
                    }
                })
                .catch(err => console.error("Diet load error:", err));
        }

        // ==========================================
        // B. ë¹„ë§Œ ìœ„í—˜ë„ ë¡œë“œ (ë„ë„›)
        // ==========================================
        function loadObesitySection(date) {
            fetch(`/api/report/daily?date=${date}`)
                .then(res => res.json())
                .then(data => {
                    // í™•ë¥  (0~100)
                    const prob = parseInt(data.obesityProbability || 0);

                    // í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
                    document.getElementById('obesityPercent').innerText = `${prob}%`;

                    // ì°¨íŠ¸ ì—…ë°ì´íŠ¸
                    updateObesityChart(prob);
                })
                .catch(err => console.error("Obesity load error:", err));
        }

        // ==========================================
        // C. ê³µí†µ íŠ¸ë Œë“œ ë¡œë“œ (í•˜ë‹¨ ì˜ì—­)
        // ==========================================
        function loadCommonData(date) {
            fetch(`/api/report/daily?date=${date}`)
                .then(res => res.json())
                .then(data => {
                    updateCommonCharts(data);
                })
                .catch(err => console.error("Common load error:", err));
        }


        // ---------------------------------------------------
        // [ì°¨íŠ¸ ê·¸ë¦¬ê¸° í•¨ìˆ˜ë“¤]
        // ---------------------------------------------------

        function updateRadarChart(data) {
            const ctxRadar = document.getElementById('diabetesRadarChart');
            if (radarChart) radarChart.destroy();

            radarChart = new Chart(ctxRadar, {
                type: 'radar',
                data: {
                    labels: ['íƒ„ìˆ˜í™”ë¬¼', 'ë‹¨ë°±ì§ˆ', 'ì§€ë°©', 'ë‹¹ë¥˜', 'ë‚˜íŠ¸ë¥¨'], // ë‚˜íŠ¸ë¥¨ ë°˜ì˜
                    datasets: [{
                        label: 'ë‚˜ì˜ ì„­ì·¨(%)',
                        data: data.radarMyIntake || [0,0,0,0,0],
                        borderColor: COLOR_DANGER,
                        backgroundColor: 'rgba(255, 107, 107, 0.2)',
                        borderWidth: 2,
                        pointRadius: 3
                    }, {
                        label: 'ê¶Œì¥(%)',
                        data: data.radarGoal || [100,100,100,100,100],
                        borderColor: COLOR_PRIMARY,
                        backgroundColor: 'transparent',
                        borderDash: [5,5],
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            suggestedMin: 0,
                            suggestedMax: 120,
                            pointLabels: { font: { size: 12 } },
                            ticks: { display: false } // ì§€ì €ë¶„í•œ ìˆ«ì ìˆ¨ê¹€
                        }
                    },
                    plugins: { legend: { position: 'top' } }
                }
            });
        }

        function updateObesityChart(probability) {
            const ctxObesity = document.getElementById('obesityRiskChart');
            if (obesityChart) obesityChart.destroy();

            obesityChart = new Chart(ctxObesity, {
                type: 'doughnut',
                data: {
                    labels: ['ìœ„í—˜', 'ì•ˆì „'],
                    datasets: [{
                        data: [probability, 100 - probability],
                        backgroundColor: [COLOR_DANGER, '#EEEEEE'],
                        borderWidth: 0,
                        hoverOffset: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false, // ë¶€ëª¨ div í¬ê¸°ì— ë§ì¶¤
                    cutout: '85%',              // ì–‡ì€ ë„ë„›
                    plugins: {
                        legend: { display: false },
                        tooltip: { enabled: false }
                    },
                    animation: {
                        animateScale: true,
                        animateRotate: true
                    }
                }
            });
        }

        function updateCommonCharts(data) {
            // 1. ê±´ê°• ì ìˆ˜ (Line)
            document.getElementById('avgScoreBadge').innerText = `í‰ê·  ${data.averageScore}ì `;
            const ctxScore = document.getElementById('scoreChart');
            if (scoreChart) scoreChart.destroy();
            scoreChart = new Chart(ctxScore, {
                type: 'line',
                data: {
                    labels: data.scoreDates || [],
                    datasets: [{
                        label: 'ì ìˆ˜',
                        data: data.scoreValues || [],
                        borderColor: COLOR_PRIMARY,
                        backgroundColor: 'rgba(29, 171, 135, 0.1)',
                        fill: true, tension: 0.4
                    }]
                },
                options: { responsive: true, scales: { y: { min: 0, max: 100 } }, plugins: { legend: { display: false } } }
            });

            // 2. ì‹ë‹¨ ìœ í˜• (3ê°œ ë¶„ë¦¬ - ê³„ë‹¨í˜• ê·¸ë˜í”„)
            // ê³µí†µ ìƒì„± í•¨ìˆ˜
            const createStepChart = (ctxId, chartRef, label, dates, codes, color) => {
                const ctx = document.getElementById(ctxId);
                if (chartRef) chartRef.destroy();
                return new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: dates || [],
                        datasets: [{
                            label: label,
                            data: codes || [],
                            borderColor: color, stepped: true, fill: false, borderWidth: 2, pointRadius: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                min: 0, max: 4, // 1~3 í‘œì‹œìš©
                                ticks: {
                                    stepSize: 1,
                                    font: { size: 11 },
                                    callback: function(val) {
                                        if(val === 1) return 'ì €';
                                        if(val === 2) return 'ê· í˜•';
                                        if(val === 3) return 'ê³ ';
                                        return '';
                                    }
                                },
                                grid: { drawBorder: false }
                            },
                            x: {
                                display: true,
                                ticks: { maxTicksLimit: 6, maxRotation: 0, autoSkip: true },
                                grid: { display: false }
                            }
                        },
                        plugins: { legend: { display: false }, title: { display: true, text: label, align: 'start', padding: {bottom: 10} } }
                    }
                });
            };

            // ì°¨íŠ¸ 3ê°œ ìƒì„±
            carbChart = createStepChart('carbChart', carbChart, 'íƒ„ìˆ˜í™”ë¬¼', data.dietDates, data.carbCodes, '#FFC857');
            proteinChart = createStepChart('proteinChart', proteinChart, 'ë‹¨ë°±ì§ˆ', data.dietDates, data.proteinCodes, '#1DAB87');
            fatChart = createStepChart('fatChart', fatChart, 'ì§€ë°©', data.dietDates, data.fatCodes, '#FF6B6B');

            // 3. Top 5 ë¦¬ìŠ¤íŠ¸
            const ul = document.getElementById('topMealsList');
            ul.innerHTML = '';
            if(data.topMeals && data.topMeals.length > 0) {
                data.topMeals.forEach((m, i) => {
                    const li = document.createElement('li');
                    const category = m.mealTime ? `(${m.mealTime})` : '';
                    li.innerHTML = `<strong>${i+1}. ${m.mealName}</strong> <span style="color:#888; font-size:0.9em;">${category}</span>`;
                    ul.appendChild(li);
                });
            } else {
                ul.innerHTML = '<p style="color:#999; text-align:center; padding: 10px;">ê¸°ë¡ ì—†ìŒ</p>';
            }
        }
    </script>
</th:block>
</body>
</html>
