<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.Ex02.mapper.CommunityMapper">

    <select id="selectPostList" resultType="com.example.Ex02.dto.CommunityPostDto">
        SELECT
        P.POST_ID AS postId,
        P.USER_ID AS userId,
        P.CONTENT AS content,
        P.HEALTH_SCORE AS healthScore,
        P.CREATED_AT AS createdAt,

        U.NICKNAME AS authorNickname,
        U.PROFILE_IMAGE_URL AS authorProfileImageUrl,
        U.CURRENT_PERSONA AS authorPersona,

        COUNT(DISTINCT L.LIKE_ID) AS likeCount,
        COUNT(DISTINCT C.COMMENT_ID) AS commentCount,

        <!-- [수정] CASE WHEN 구문이 SELECT 절 안으로 이동 -->
        CASE WHEN EXISTS (
            SELECT 1
            FROM LIKES LikedByMe
            WHERE LikedByMe.POST_ID = P.POST_ID AND LikedByMe.USER_ID = #{currentUserId}
        ) THEN 1 ELSE 0 END AS likedByMe

        FROM
        POSTS P
        JOIN
        USERS U ON P.USER_ID = U.USER_ID
        LEFT JOIN
        LIKES L ON P.POST_ID = L.POST_ID
        LEFT JOIN
        COMMENTS C ON P.POST_ID = C.POST_ID
        GROUP BY
        P.POST_ID, P.USER_ID, P.CONTENT, P.HEALTH_SCORE, P.CREATED_AT,
        U.NICKNAME, U.PROFILE_IMAGE_URL, U.CURRENT_PERSONA
        ORDER BY
        P.CREATED_AT DESC
    </select>

    <select id="selectImagesByPostId" resultType="String">
        SELECT
        IMAGE_URL
        FROM
        POST_IMAGES
        WHERE
        POST_ID = #{postId}
        ORDER BY
        DISPLAY_ORDER
    </select>

    <select id="selectCommentsByPostId" resultType="com.example.Ex02.dto.CommentDto">
        SELECT
        C.COMMENT_ID AS commentId,
        C.POST_ID AS postId,
        C.USER_ID AS userId,
        C.CONTENT AS content,
        C.CREATED_AT AS createdAt,

        U.NICKNAME AS authorNickname,
        U.PROFILE_IMAGE_URL AS authorProfileImageUrl
        FROM
        COMMENTS C
        JOIN
        USERS U ON C.USER_ID = U.USER_ID
        WHERE
        C.POST_ID = #{postId}
        ORDER BY
        C.CREATED_AT ASC
    </select>

    <select id="selectTrendingList" resultType="com.example.Ex02.dto.TrendingPostDto">
        SELECT
        P.POST_ID AS postId,
        U.NICKNAME AS authorNickname,
        SUBSTR(P.CONTENT, 1, 50) AS summary, (COUNT(DISTINCT L.LIKE_ID) + COUNT(DISTINCT C.COMMENT_ID)) AS engagementScore
        FROM
        POSTS P
        JOIN
        USERS U ON P.USER_ID = U.USER_ID
        LEFT JOIN
        LIKES L ON P.POST_ID = L.POST_ID
        LEFT JOIN
        COMMENTS C ON P.POST_ID = C.POST_ID
        WHERE
        P.CREATED_AT >= (SYSDATE - 7)
        GROUP BY
        P.POST_ID,
        U.NICKNAME,
        P.CONTENT ORDER BY
        engagementScore DESC
        FETCH FIRST 5 ROWS ONLY </select>

</mapper>