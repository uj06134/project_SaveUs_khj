<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.Ex02.mapper.ChallengeMapper">

    <resultMap id="ChallengeCardResultMap" type="com.example.Ex02.dto.ChallengeCardDto">
        <id property="challengeId" column="CHALLENGE_ID"/>
        <result property="title" column="TITLE"/>
        <result property="description" column="DESCRIPTION"/>
        <result property="imageUrl" column="IMAGE_URL"/>
        <result property="challengeType" column="CHALLENGE_TYPE"/>
        <result property="metricKey" column="METRIC_KEY"/>
        <result property="targetValue" column="TARGET_VALUE"/>
        <result property="isUserParticipating" column="IS_PARTICIPATING" javaType="boolean"/>
        <result property="points" column="POINTS"/>
        <result property="participationStatus" column="PARTICIPATION_STATUS"/>
        <collection property="tags" ofType="com.example.Ex02.dto.TagDto">
            <id property="tagId" column="TAG_ID"/>
            <result property="tagName" column="TAG_NAME"/>
        </collection>
    </resultMap>

    <resultMap id="MyChallengeItemResultMap" type="com.example.Ex02.dto.MyChallengeItemDto">
        <id property="challengeId" column="CHALLENGE_ID"/>
        <result property="title" column="TITLE"/>
        <result property="description" column="DESCRIPTION"/>
        <result property="imageUrl" column="IMAGE_URL"/>
        <result property="userChallengeId" column="USER_CHALLENGE_ID"/>
        <result property="status" column="STATUS"/>
        <result property="progressPercent" column="PROGRESS_PERCENT"/>
        <result property="startValue" column="START_VALUE"/>
        <result property="currentCount" column="CURRENT_COUNT"/>
        <result property="challengeType" column="CHALLENGE_TYPE"/>
        <result property="metricKey" column="METRIC_KEY"/>
        <result property="targetValue" column="TARGET_VALUE"/>
        <result property="userId" column="USER_ID"/>
        <result property="durationDays" column="DURATION_DAYS"/>
        <result property="points" column="POINTS"/>
        <result property="successCount" column="SUCCESS_COUNT"/>
    </resultMap>

    <select id="findLeaderboardTop5" resultType="com.example.Ex02.dto.LeaderboardEntryDto">
        SELECT
        U.NICKNAME AS userNickname,
        U.PROFILE_IMAGE_URL AS userProfileImg,
        U.TOTAL_POINTS AS score
        FROM USERS U
        WHERE U.TOTAL_POINTS > 0
        ORDER BY score DESC
        FETCH FIRST 5 ROWS ONLY
    </select>

    <select id="findTop50Leaderboard" resultType="com.example.Ex02.dto.LeaderboardEntryDto">
        SELECT
        U.NICKNAME AS userNickname,
        U.PROFILE_IMAGE_URL AS userProfileImg,
        U.TOTAL_POINTS AS score
        FROM USERS U
        WHERE U.TOTAL_POINTS > 0
        ORDER BY score DESC
    </select>

    <select id="findAllTags" resultType="com.example.Ex02.dto.TagDto">
        SELECT TAG_ID, TAG_NAME FROM TAGS ORDER BY TAG_NAME
    </select>

    <select id="findAllChallengesPaginated" resultMap="ChallengeCardResultMap" parameterType="map">
        SELECT
        C.CHALLENGE_ID, C.TITLE, C.DESCRIPTION, C.IMAGE_URL,
        C.POINTS, C.CHALLENGE_TYPE, C.METRIC_KEY, C.TARGET_VALUE,
        T.TAG_ID, T.TAG_NAME,
        COALESCE(UC.STATUS, 'NONE') AS PARTICIPATION_STATUS
        FROM CHALLENGES C
        LEFT JOIN CHALLENGE_TAGS CT ON C.CHALLENGE_ID = CT.CHALLENGE_ID
        LEFT JOIN TAGS T ON CT.TAG_ID = T.TAG_ID
        LEFT JOIN USER_CHALLENGES UC ON C.CHALLENGE_ID = UC.CHALLENGE_ID AND UC.USER_ID = #{userId}
        <where>
            <if test="keyword != null and keyword != ''">
                (C.TITLE LIKE '%' || #{keyword} || '%' OR C.DESCRIPTION LIKE '%' || #{keyword} || '%')
            </if>
            <if test="tag != null and tag != ''">
                AND C.CHALLENGE_ID IN (
                SELECT CT2.CHALLENGE_ID
                FROM CHALLENGE_TAGS CT2
                JOIN TAGS T2 ON CT2.TAG_ID = T2.TAG_ID
                WHERE T2.TAG_NAME = #{tag}
                )
            </if>
        </where>
        ORDER BY C.CHALLENGE_ID DESC
        OFFSET #{offset} ROWS
        FETCH NEXT #{limit} ROWS ONLY
    </select>

    <select id="countAllChallenges" resultType="int" parameterType="map">
        SELECT COUNT(DISTINCT C.CHALLENGE_ID)
        FROM CHALLENGES C
        <where>
            <if test="keyword != null and keyword != ''">
                (C.TITLE LIKE '%' || #{keyword} || '%' OR C.DESCRIPTION LIKE '%' || #{keyword} || '%')
            </if>
            <if test="tag != null and tag != ''">
                AND C.CHALLENGE_ID IN (
                SELECT CT2.CHALLENGE_ID
                FROM CHALLENGE_TAGS CT2
                JOIN TAGS T2 ON CT2.TAG_ID = T2.TAG_ID
                WHERE T2.TAG_NAME = #{tag}
                )
            </if>
        </where>
    </select>

    <select id="findChallengesByGoal" resultMap="ChallengeCardResultMap">
        SELECT
        C.CHALLENGE_ID, C.TITLE, C.DESCRIPTION, C.IMAGE_URL,
        C.POINTS, C.CHALLENGE_TYPE, C.METRIC_KEY, C.TARGET_VALUE,
        T.TAG_ID, T.TAG_NAME,
        COALESCE(UC.STATUS, 'NONE') AS PARTICIPATION_STATUS
        FROM CHALLENGES C
        LEFT JOIN CHALLENGE_TAGS CT ON C.CHALLENGE_ID = CT.CHALLENGE_ID
        LEFT JOIN TAGS T ON CT.TAG_ID = T.TAG_ID
        LEFT JOIN USER_CHALLENGES UC ON C.CHALLENGE_ID = UC.CHALLENGE_ID AND UC.USER_ID = #{userId}
        WHERE C.TARGET_GOAL = #{goal}
        FETCH FIRST 3 ROWS ONLY
    </select>

    <select id="findChallengesByPersona" resultMap="ChallengeCardResultMap">
        SELECT
        C.CHALLENGE_ID, C.TITLE, C.DESCRIPTION, C.IMAGE_URL,
        C.POINTS,C.CHALLENGE_TYPE, C.METRIC_KEY, C.TARGET_VALUE,
        T.TAG_ID, T.TAG_NAME,
        COALESCE(UC.STATUS, 'NONE') AS PARTICIPATION_STATUS
        FROM CHALLENGES C
        LEFT JOIN CHALLENGE_TAGS CT ON C.CHALLENGE_ID = CT.CHALLENGE_ID
        LEFT JOIN TAGS T ON CT.TAG_ID = T.TAG_ID
        LEFT JOIN USER_CHALLENGES UC ON C.CHALLENGE_ID = UC.CHALLENGE_ID AND UC.USER_ID = #{userId}
        WHERE C.TARGET_PERSONA = #{persona}
        FETCH FIRST 2 ROWS ONLY
    </select>

    <select id="countMyChallengesByStatus" resultType="int">
        SELECT COUNT(USER_CHALLENGE_ID) FROM USER_CHALLENGES WHERE USER_ID = #{userId} AND STATUS = #{status}
    </select>

    <select id="getMyTotalPoints" resultType="int">
        SELECT TOTAL_POINTS FROM USERS WHERE USER_ID = #{userId}
    </select>

    <select id="findUserMainGoal" resultType="Integer">
        SELECT MAIN_GOAL FROM USERS WHERE USER_ID = #{userId}
    </select>

    <select id="findMyChallengesByStatus" resultMap="MyChallengeItemResultMap">
        SELECT
        C.CHALLENGE_ID, C.TITLE, C.DESCRIPTION, C.IMAGE_URL, C.DURATION_DAYS,
        C.POINTS, C.CHALLENGE_TYPE, C.METRIC_KEY, C.TARGET_VALUE,
        UC.USER_CHALLENGE_ID, UC.STATUS, UC.PROGRESS_PERCENT, UC.START_VALUE, UC.CURRENT_COUNT, UC.SUCCESS_COUNT
        FROM CHALLENGES C
        JOIN USER_CHALLENGES UC ON C.CHALLENGE_ID = UC.CHALLENGE_ID
        WHERE UC.USER_ID = #{userId} AND UC.STATUS = #{status}
        ORDER BY UC.START_DATE DESC
    </select>

    <select id="getUserWeight" resultType="Double">
        SELECT CURRENT_WEIGHT FROM USERS WHERE USER_ID = #{userId}
    </select>

    <select id="findChallengeDetail" resultMap="ChallengeCardResultMap">
        SELECT * FROM CHALLENGES WHERE CHALLENGE_ID = #{challengeId}
    </select>

    <insert id="joinChallenge">
        INSERT INTO USER_CHALLENGES (
        USER_ID,
        CHALLENGE_ID,
        START_VALUE,
        STATUS,
        CURRENT_COUNT,
        PROGRESS_PERCENT,
        START_DATE
        ) VALUES (
        #{userId},
        #{challengeId},
        #{startValue, jdbcType=NUMERIC}, 'ONGOING',
        0,
        0,
        SYSDATE
        )
    </insert>

    <select id="findAllActiveChallenges" resultMap="MyChallengeItemResultMap">
        SELECT
        C.CHALLENGE_ID, C.TITLE, C.CHALLENGE_TYPE, C.METRIC_KEY, C.TARGET_VALUE,
        C.DURATION_DAYS, C.POINTS,
        UC.USER_CHALLENGE_ID, UC.USER_ID, UC.STATUS, UC.START_VALUE, UC.CURRENT_COUNT
        FROM USER_CHALLENGES UC
        JOIN CHALLENGES C ON UC.CHALLENGE_ID = C.CHALLENGE_ID
        WHERE UC.STATUS = 'ONGOING'
    </select>

    <update id="updateProgress">
        UPDATE USER_CHALLENGES
        SET CURRENT_COUNT = #{currentCount},
        PROGRESS_PERCENT = #{progressPercent},  LAST_CHECKED_AT = SYSDATE
        WHERE USER_CHALLENGE_ID = #{userChallengeId}
    </update>

    <update id="completeChallenge">
        UPDATE USER_CHALLENGES
        SET STATUS = 'COMPLETED',
        PROGRESS_PERCENT = 100,
        LAST_CHECKED_AT = SYSDATE,
        SUCCESS_COUNT = SUCCESS_COUNT + 1
        WHERE USER_CHALLENGE_ID = #{userChallengeId}
    </update>

    <select id="sumTotalSuccessCount" resultType="int">
        SELECT COALESCE(SUM(SUCCESS_COUNT), 0)
        FROM USER_CHALLENGES
        WHERE USER_ID = #{userId}
    </select>

    <update id="failChallenge">
        UPDATE USER_CHALLENGES
        SET STATUS = 'FAILED',
        LAST_CHECKED_AT = SYSDATE
        WHERE USER_CHALLENGE_ID = #{userChallengeId}
    </update>

    <select id="findUserChallengeById" resultMap="MyChallengeItemResultMap">
        SELECT
        C.CHALLENGE_ID, C.CHALLENGE_TYPE, C.METRIC_KEY, C.TARGET_VALUE,
        UC.USER_CHALLENGE_ID, UC.USER_ID, UC.STATUS, UC.START_VALUE, UC.CURRENT_COUNT
        FROM USER_CHALLENGES UC
        JOIN CHALLENGES C ON UC.CHALLENGE_ID = C.CHALLENGE_ID
        WHERE UC.USER_CHALLENGE_ID = #{userChallengeId}
    </select>

    <update id="resetChallenge">
        UPDATE USER_CHALLENGES
        SET STATUS = 'ONGOING',
        CURRENT_COUNT = 0,
        PROGRESS_PERCENT = 0,
        START_DATE = SYSDATE,
        START_VALUE = #{startValue, jdbcType=NUMERIC}, LAST_CHECKED_AT = NULL
        WHERE USER_CHALLENGE_ID = #{userChallengeId}
    </update>

    <delete id="deleteUserChallenge">
        DELETE FROM USER_CHALLENGES WHERE USER_CHALLENGE_ID = #{userChallengeId}
    </delete>

    <update id="addUserPoint">
        UPDATE USERS
        SET TOTAL_POINTS = TOTAL_POINTS + #{points}
        WHERE USER_ID = #{userId}
    </update>

    <insert id="insertUserBadge">
        INSERT INTO USER_BADGES (USER_ID, CHALLENGE_ID)
        SELECT #{userId}, #{challengeId}
        FROM DUAL
        WHERE NOT EXISTS (
        SELECT 1
        FROM USER_BADGES
        WHERE USER_ID = #{userId}
        AND CHALLENGE_ID = #{challengeId}
        )
    </insert>

</mapper>