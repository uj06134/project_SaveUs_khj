<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">

<head>
    <title>Dashboard</title>
    <th:block layout:fragment="css">
        <link rel="stylesheet" th:href="@{/css/dashboard.css}">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
        <link rel="stylesheet" th:href="@{/css/dashboard.css}" />
    </th:block>
</head>

<main layout:fragment="content">
    <div class="top-section">
        <div class="welcome-card">
            <div class="user-info">
                <img class="user-photo"
                     th:src="${(user.profileImageUrl != null && user.profileImageUrl != '') ? user.profileImageUrl : '/images/user-default.png'}"
                     alt="user">

                <div>
                    <h2>
                        환영합니다, <span th:text="${user.nickname}"></span>님!
                    </h2>
                    <span class="goal-tag" th:text="${goalName}"></span>
                </div>
            </div>
        </div>

        <div class="tip-card">
            <h4>오늘의 체중</h4>

            <div class="weight-input-wrapper">
                <input type="number" id="todayWeightInput" placeholder="현재의 체중을 입력">
                <button id="saveWeightBtn" type="button">입력</button>

                <!-- 저장 버튼 오른쪽에 현재 체중과 BMI 표시 -->
                <div class="weight-info">
                    <span>현재의 체중: <strong id="currentWeightText" th:data-height="${user.height}" th:text="${user.currentWeight} + ' kg'"></strong></span>
                    <span>BMI: <strong id="bmiValue" th:text="${user.bmi}"></strong></span>
                    <span>상태: <strong id="bmiStatus"></strong></span>
                </div>
            </div>
        </div>






    </div>

    <!-- 아래는 기존 식사/영양 요약 그대로 유지 -->
    <!-- 생략하지 않고 전체 그대로 유지하여 정상 동작 -->

    <!-- 식사 기록 -->
    <section class="log-meal">
        <h3>오늘의 식사 기록하기</h3>
        <p class="sub">AI 사진 분석 또는 입력을 통해 식사를 기록할 수 있습니다.</p>

        <div class="log-actions">
            <input type="file" id="aiFileInput" style="display: none;" accept="image/*">
            <button class="photo-upload-btn">
                <span>AI 사진 업로드</span>
            </button>

            <button class="add-meal-btn" onclick="location.href='/direct-input'">직접 입력</button>

            <div class="meal-search-area">
                <div class="search-group">
                    <input type="text" id="mealSearchInput" placeholder="음식명 검색">
                    <div id="autocompleteBox" class="autocomplete-box"></div>
                    <button id="mealAddBtn">추가</button>
                </div>
            </div>
        </div>
    </section>

    <div class="stats-section">

        <div class="meals-card">
            <h4>오늘의 식사</h4>

            <ul class="meal-list">
                <li th:each="meal : ${todayMeals}" class="meal-item">
                    <a th:href="@{/meal/edit/{id}(id=${meal.entryId})}" class="meal-link">
                        <div class="meal-left">
                            <strong th:text="${meal.mealName}"></strong>
                            <p class="time" th:text="${meal.mealTime}"></p>
                        </div>
                        <span class="kcal" th:text="${meal.calories + ' kcal'}"></span>
                    </a>
                </li>

                <li th:if="${#lists.isEmpty(todayMeals)}" class="no-data">
                    오늘은 아직 식사 기록이 없습니다.
                </li>
            </ul>
        </div>

        <div class="right-summary">

            <div class="summary-card">
                <div class="summary-header">
                    <p class="title">칼로리</p>

                    <h3 class="value"
                        th:classappend="${totalCalories > goalCalories} ? ' over'">
                        <span th:text="${totalCalories}"></span>
                        /
                        <span th:text="${goalCalories}"></span> kcal
                    </h3>
                </div>

                <div class="progress-bar">
                    <div class="progress-fill calorie-bar"
                         th:classappend="${totalCalories > goalCalories} ? ' progress-over'"
                         th:style="'width:' + ( (${totalCalories} / ${goalCalories}) > 1 ? 100 : (${totalCalories} / ${goalCalories} * 100) ) + '%' ">
                    </div>
                </div>

                <p class="percent-text"
                   th:classappend="${totalCalories > goalCalories} ? ' over'"
                   th:text="${(totalCalories * 100 / goalCalories) > 100 ? 100 : T(java.lang.Math).round((totalCalories * 100.0) / goalCalories)} + '%'">
                </p>
            </div>

            <div class="nutrient-summary">

                <!-- 탄수화물 -->
                <div class="summary-card">
                    <div class="summary-header">
                        <p class="title">탄수화물</p>

                        <h3 class="value"
                            th:classappend="${totalCarbs > goal.carbsG} ? ' over'">
                            <span th:text="${totalCarbs}"></span>
                            /
                            <span th:text="${goal.carbsG}"></span> g
                        </h3>
                    </div>

                    <div class="progress-bar">
                        <div class="progress-fill carbs-bar"
                             th:classappend="${totalCarbs > goal.carbsG} ? ' progress-over'"
                             th:style="'width:' + ( (${totalCarbs} / ${goal.carbsG}) > 1 ? 100 : (${totalCarbs} / ${goal.carbsG} * 100) ) + '%' ">
                        </div>
                    </div>

                    <p class="percent-text"
                       th:classappend="${totalCarbs > goal.carbsG} ? ' over' "
                       th:text="${(totalCarbs * 100 / goal.carbsG) > 100 ? 100 : T(java.lang.Math).round((totalCarbs * 100.0) / goal.carbsG)} + '%'">
                    </p>
                </div>

                <!-- 단백질 -->
                <div class="summary-card">
                    <div class="summary-header">
                        <p class="title">단백질</p>

                        <h3 class="value"
                            th:classappend="${totalProtein > goal.proteinG} ? ' over'">
                            <span th:text="${totalProtein}"></span>
                            /
                            <span th:text="${goal.proteinG}"></span> g
                        </h3>
                    </div>

                    <div class="progress-bar">
                        <div class="progress-fill protein-bar"
                             th:classappend="${totalProtein > goal.proteinG} ? ' progress-over' "
                             th:style="'width:' + ( (${totalProtein} / ${goal.proteinG}) > 1 ? 100 : (${totalProtein} / ${goal.proteinG} * 100) ) + '%' ">
                        </div>
                    </div>

                    <p class="percent-text"
                       th:classappend="${totalProtein > goal.proteinG} ? ' over' "
                       th:text="${(totalProtein * 100 / goal.proteinG) > 100 ? 100 : T(java.lang.Math).round((totalProtein * 100.0) / goal.proteinG)} + '%'">
                    </p>
                </div>

                <!-- 지방 -->
                <div class="summary-card">
                    <div class="summary-header">
                        <p class="title">지방</p>

                        <h3 class="value"
                            th:classappend="${totalFat > goal.fatsG} ? ' over' ">
                            <span th:text="${totalFat}"></span>
                            /
                            <span th:text="${goal.fatsG}"></span> g
                        </h3>
                    </div>

                    <div class="progress-bar">
                        <div class="progress-fill fat-bar"
                             th:classappend="${totalFat > goal.fatsG} ? ' progress-over' "
                             th:style="'width:' + ( (${totalFat} / ${goal.fatsG}) > 1 ? 100 : (${totalFat} / ${goal.fatsG} * 100) ) + '%' ">
                        </div>
                    </div>

                    <p class="percent-text"
                       th:classappend="${totalFat > goal.fatsG} ? ' over' "
                       th:text="${(totalFat * 100 / goal.fatsG) > 100 ? 100 : T(java.lang.Math).round((totalFat * 100.0) / goal.fatsG)} + '%'">
                    </p>
                </div>

                <div class="extra-nutrients">
                    <div class="extra-card">
                        <p class="extra-title">당류</p>
                        <h3 class="extra-value" th:text="${totalSugar + ' g'}"></h3>
                    </div>

                    <div class="extra-card">
                        <p class="extra-title">식이섬유</p>
                        <h3 class="extra-value" th:text="${totalFiber + ' g'}"></h3>
                    </div>

                    <div class="extra-card">
                        <p class="extra-title">칼슘</p>
                        <h3 class="extra-value" th:text="${totalCalcium + ' mg'}"></h3>
                    </div>

                    <div class="extra-card">
                        <p class="extra-title">나트륨</p>
                        <h3 class="extra-value" th:text="${totalSodium + ' mg'}"></h3>
                    </div>
                </div>
            </div>

        </div>
    </div>

</main>

<th:block layout:fragment="script">
    <script src="/js/foodWeight.js"></script>
    <script src="/js/foodAdd.js?v=new_ai_ver1"></script>
</th:block>

</html>
